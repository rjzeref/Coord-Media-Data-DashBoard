<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Multimodal Demo - Dashboard</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    h1 {
      color: white;
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.5em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    @media (max-width: 968px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }
    
    .card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .card h2 {
      color: #667eea;
      margin-bottom: 20px;
      font-size: 1.5em;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      color: #333;
      font-weight: 500;
    }
    
    input[type="text"],
    input[type="number"],
    input[type="file"],
    select,
    textarea {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    
    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: transform 0.2s, box-shadow 0.2s;
      width: 100%;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    #map {
      height: 500px;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .media-list {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .media-item {
      background: #f8f9fa;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }
    
    .media-item h4 {
      color: #333;
      margin-bottom: 5px;
    }
    
    .media-item p {
      color: #666;
      font-size: 14px;
      margin: 3px 0;
    }
    
    .media-item .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 8px;
    }
    
    .tag {
      background: #667eea;
      color: white;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 12px;
    }
    
    .project-item {
      background: #f0f7ff;
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .project-item strong {
      color: #333;
    }
    
    .distance {
      background: #4CAF50;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .message {
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 15px;
      display: none;
    }
    
    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .message.show {
      display: block;
    }
    
    .full-width {
      grid-column: 1 / -1;
    }
    
    .two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    
    .file-upload-area {
      border: 2px dashed #667eea;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      background: #f8f9ff;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .file-upload-area:hover {
      background: #f0f2ff;
    }
    
    .file-upload-area.dragover {
      background: #e8ebff;
      border-color: #764ba2;
    }
    
    .loader {
      display: none;
      text-align: center;
      padding: 20px;
    }
    
    .loader.show {
      display: block;
    }
    
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üó∫Ô∏è Multimodal Demo Dashboard</h1>
    
    <div class="grid">
      <!-- Map Section -->
      <div class="card full-width">
        <h2>üìç Location Map</h2>
        <div id="map"></div>
      </div>
      
      <!-- Add Media Section -->
      <div class="card">
        <h2>üìÅ Add Multimedia</h2>
        <div id="mediaMessage" class="message"></div>
        
        <form id="mediaForm" onsubmit="addMedia(event)" enctype="multipart/form-data">
          <div class="form-group">
            <label for="ownerType">Owner Type:</label>
            <select id="ownerType" required>
              <option value="employee">Employee</option>
              <option value="project">Project</option>
              <option value="other">Other</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="ownerId">Owner ID:</label>
            <input type="text" id="ownerId" placeholder="e.g., EMP1001" required>
          </div>
          
          <div class="form-group">
            <label for="fileInput">üì§ Upload File:</label>
            <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('fileInput').click()">
              <input type="file" id="fileInput" style="display: none;" onchange="handleFileSelect(event)" accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx">
              <p id="fileUploadText" style="margin: 10px 0;">
                <strong>Click to select a file</strong><br>
                <small style="color: #666;">or drag and drop here</small><br>
                <small style="color: #999;">Supports: Images, Videos, Audio, PDFs, Documents (Max: 50MB)</small>
              </p>
            </div>
            <div id="filePreview" style="margin-top: 10px; display: none;">
              <p style="color: #667eea; font-weight: 600;">Selected File:</p>
              <p id="fileInfo" style="color: #666; font-size: 14px;"></p>
            </div>
          </div>
          
          <div class="form-group">
            <label for="uploadedBy">Uploaded By:</label>
            <input type="text" id="uploadedBy" placeholder="e.g., hr_user">
          </div>
          
          <div class="form-group">
            <label for="tags">Tags (comma-separated):</label>
            <input type="text" id="tags" placeholder="e.g., profile, photo">
          </div>
          
          <div class="form-group">
            <label for="description">Description:</label>
            <textarea id="description" placeholder="Brief description..."></textarea>
          </div>
          
          <button type="submit">‚ûï Upload & Add Media</button>
        </form>
      </div>
      
      <!-- View Media Section -->
      <div class="card">
        <h2>üìã View Employee Data</h2>
        <div class="form-group">
          <label for="searchOwnerType">Search Type:</label>
          <select id="searchOwnerType" onchange="toggleSearchFields()">
            <option value="employee">Employee</option>
            <option value="project">Project</option>
            <option value="other">Other</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="searchOwnerId">Employee/Owner ID:</label>
          <input type="text" id="searchOwnerId" placeholder="e.g., EMP1001">
        </div>
        
        <button onclick="loadEmployeeData()">üîç Search</button>
        
        <div class="loader" id="mediaLoader">
          <div class="spinner"></div>
          <p>Loading...</p>
        </div>
        
        <div id="employeeResults" style="margin-top: 20px;">
          <div id="mediaSection">
            <h3 style="color: #667eea; margin-bottom: 15px; display: none;" id="mediaTitle">üìÅ Media Files</h3>
            <div id="mediaList" class="media-list"></div>
          </div>
          
          <div id="projectSection" style="margin-top: 20px;">
            <h3 style="color: #667eea; margin-bottom: 15px; display: none;" id="projectTitle">üìå Associated Projects</h3>
            <div id="projectList"></div>
          </div>
        </div>
      </div>
      
      <!-- Add Project Location Section -->
      <div class="card">
        <h2>üìå Add Project Location</h2>
        <div id="locationMessage" class="message"></div>
        
        <form id="locationForm" onsubmit="addProjectLocation(event)">
          <div class="form-group">
            <label for="projId">Project ID:</label>
            <input type="number" id="projId" placeholder="e.g., 10" required>
          </div>
          
          <div class="form-group">
            <label for="projName">Project Name:</label>
            <input type="text" id="projName" placeholder="e.g., New Office Site" required>
          </div>
          
          <div class="form-group">
            <label for="projDescription">Description:</label>
            <textarea id="projDescription" placeholder="Project description..."></textarea>
          </div>
          
          <div class="form-group">
            <label for="employeeId">Employee ID:</label>
            <input type="text" id="employeeId" placeholder="e.g., EMP1001" required>
            <small style="color: #666; margin-top: 5px; display: block;">Link this project to an employee</small>
          </div>
          
          <div class="form-group">
            <label for="cityName">üåç City/Location:</label>
            <div style="display: flex; gap: 10px;">
              <input type="text" id="cityName" placeholder="e.g., Mumbai, India or New York, USA" style="flex: 1;">
              <button type="button" onclick="geocodeCity()" style="width: auto; padding: 10px 20px;">üîç Find</button>
            </div>
            <small style="color: #666; margin-top: 5px; display: block;">Enter a city name and click Find to get coordinates automatically</small>
          </div>
          
          <div id="coordsDisplay" style="display: none; margin: 15px 0; padding: 12px; background: #f0f7ff; border-radius: 6px; border-left: 4px solid #667eea;">
            <p style="margin: 0; color: #333;"><strong>üìç Found Location:</strong></p>
            <p id="foundCity" style="margin: 5px 0 0 0; color: #666; font-size: 14px;"></p>
            <p id="foundCoords" style="margin: 5px 0 0 0; color: #667eea; font-size: 14px; font-weight: 600;"></p>
          </div>
          
          <div class="two-col">
            <div class="form-group">
              <label for="longitude">Longitude:</label>
              <input type="number" id="longitude" step="any" placeholder="Auto-filled from city" readonly style="background: #f5f5f5;">
            </div>
            
            <div class="form-group">
              <label for="latitude">Latitude:</label>
              <input type="number" id="latitude" step="any" placeholder="Auto-filled from city" readonly style="background: #f5f5f5;">
            </div>
          </div>
          
          <div class="form-group">
            <label for="createdBy">Created By:</label>
            <input type="text" id="createdBy" placeholder="e.g., pm_user">
          </div>
          
          <button type="submit">‚ûï Add Location</button>
        </form>
        
        <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 6px; font-size: 14px;">
          üí° <strong>Tips:</strong><br>
          ‚Ä¢ Enter a city name and click "Find" to auto-fill coordinates<br>
          ‚Ä¢ Or click on the map above to manually set coordinates<br>
          ‚Ä¢ Link project to an employee by entering their ID
        </div>
      </div>
      
      <!-- All Projects List Section -->
      <div class="card">
        <h2>üìç All Project Locations</h2>
        <button onclick="loadAllProjects()" style="margin-bottom: 15px;">üîÑ Refresh List</button>
        <div class="loader" id="projectsLoader">
          <div class="spinner"></div>
          <p>Loading...</p>
        </div>
        <div id="projectsList"></div>
      </div>
    </div>
  </div>
  
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <script>
    const API_URL = 'http://localhost:3000';
    let selectedFile = null;
    
    // File upload handling
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        selectedFile = file;
        const fileSize = (file.size / 1024 / 1024).toFixed(2); // Convert to MB
        document.getElementById('fileInfo').innerHTML = `
          <strong>${file.name}</strong><br>
          Type: ${file.type}<br>
          Size: ${fileSize} MB
        `;
        document.getElementById('filePreview').style.display = 'block';
        document.getElementById('fileUploadText').innerHTML = `
          <strong style="color: #4CAF50;">‚úì File Selected</strong><br>
          <small style="color: #666;">Click to change file</small>
        `;
      }
    }
    
    // Drag and drop support
    const fileUploadArea = document.getElementById('fileUploadArea');
    
    fileUploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      fileUploadArea.classList.add('dragover');
    });
    
    fileUploadArea.addEventListener('dragleave', () => {
      fileUploadArea.classList.remove('dragover');
    });
    
    fileUploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      fileUploadArea.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) {
        document.getElementById('fileInput').files = e.dataTransfer.files;
        handleFileSelect({ target: { files: [file] } });
      }
    });
    
    // Initialize map
    const map = L.map('map').setView([17.3850, 78.4867], 6);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors',
      maxZoom: 18
    }).addTo(map);
    
    // Custom icons
    const officeIcon = L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });
    
    const projectIcon = L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });
    
    let markers = [];
    
    // Load initial locations
    async function loadLocations() {
      try {
        // Add office markers
        const offices = [
          { id: 1, name: 'Hyderabad Office', lat: 17.3850, lon: 78.4867, address: '88 MG Road, Hyderabad' },
          { id: 2, name: 'Pune Office', lat: 18.5204, lon: 73.8567, address: '50 MG Road, Pune' }
        ];
        
        offices.forEach(office => {
          const marker = L.marker([office.lat, office.lon], { icon: officeIcon })
            .addTo(map)
            .bindPopup(`<b>üè¢ ${office.name}</b><br>${office.address}`);
          markers.push(marker);
        });
        
        // Load all projects on map
        loadAllProjects();
        
      } catch (err) {
        console.error('Error loading locations:', err);
      }
    }
    
    // Click on map to get coordinates
    map.on('click', function(e) {
      document.getElementById('latitude').value = e.latlng.lat.toFixed(6);
      document.getElementById('longitude').value = e.latlng.lng.toFixed(6);
      document.getElementById('latitude').readOnly = false;
      document.getElementById('longitude').readOnly = false;
      document.getElementById('latitude').style.background = '#fff';
      document.getElementById('longitude').style.background = '#fff';
      
      // Hide city display if clicking map manually
      document.getElementById('coordsDisplay').style.display = 'none';
      
      // Add temporary marker
      const tempMarker = L.marker([e.latlng.lat, e.latlng.lng])
        .addTo(map)
        .bindPopup('Selected location')
        .openPopup();
      
      setTimeout(() => map.removeLayer(tempMarker), 3000);
    });
    
    // Geocode city name to coordinates
    async function geocodeCity() {
      const cityName = document.getElementById('cityName').value.trim();
      
      if (!cityName) {
        alert('Please enter a city name');
        return;
      }
      
      try {
        const response = await fetch(`${API_URL}/geocode/${encodeURIComponent(cityName)}`);
        const data = await response.json();
        
        if (data.success) {
          document.getElementById('latitude').value = data.latitude.toFixed(6);
          document.getElementById('longitude').value = data.longitude.toFixed(6);
          document.getElementById('latitude').readOnly = false;
          document.getElementById('longitude').readOnly = false;
          document.getElementById('latitude').style.background = '#e8f5e9';
          document.getElementById('longitude').style.background = '#e8f5e9';
          
          // Show found location
          document.getElementById('foundCity').textContent = data.city;
          document.getElementById('foundCoords').textContent = `Lat: ${data.latitude.toFixed(6)}, Lon: ${data.longitude.toFixed(6)}`;
          document.getElementById('coordsDisplay').style.display = 'block';
          
          // Center map on found location
          map.setView([data.latitude, data.longitude], 12);
          
          // Add temporary marker
          const tempMarker = L.marker([data.latitude, data.longitude], { icon: projectIcon })
            .addTo(map)
            .bindPopup(`<b>${data.city}</b>`)
            .openPopup();
          
          setTimeout(() => map.removeLayer(tempMarker), 5000);
        } else {
          alert(data.error || 'City not found. Please try a different name.');
        }
      } catch (err) {
        alert('Error finding city: ' + err.message);
      }
    }
    
    // Add media with file upload
    async function addMedia(event) {
      event.preventDefault();
      
      if (!selectedFile) {
        showMessage('mediaMessage', 'Please select a file to upload', 'error');
        return;
      }
      
      const formData = new FormData();
      formData.append('file', selectedFile);
      formData.append('owner_type', document.getElementById('ownerType').value);
      formData.append('owner_id', document.getElementById('ownerId').value);
      formData.append('uploaded_by', document.getElementById('uploadedBy').value);
      formData.append('tags', document.getElementById('tags').value);
      formData.append('description', document.getElementById('description').value);
      
      try {
        showMessage('mediaMessage', 'Uploading file...', 'success');
        
        const response = await fetch(`${API_URL}/media`, {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
          showMessage('mediaMessage', `‚úì File uploaded successfully! ID: ${result.media_id}`, 'success');
          document.getElementById('mediaForm').reset();
          selectedFile = null;
          document.getElementById('filePreview').style.display = 'none';
          document.getElementById('fileUploadText').innerHTML = `
            <strong>Click to select a file</strong><br>
            <small style="color: #666;">or drag and drop here</small><br>
            <small style="color: #999;">Supports: Images, Videos, Audio, PDFs, Documents (Max: 50MB)</small>
          `;
        } else {
          showMessage('mediaMessage', 'Error: ' + result.error, 'error');
        }
      } catch (err) {
        showMessage('mediaMessage', 'Error: ' + err.message, 'error');
      }
    }
    
    // Load employee data (media + projects)
    async function loadEmployeeData() {
      const ownerType = document.getElementById('searchOwnerType').value;
      const ownerId = document.getElementById('searchOwnerId').value;
      
      if (!ownerId) {
        alert('Please enter an Employee/Owner ID');
        return;
      }
      
      document.getElementById('mediaLoader').classList.add('show');
      document.getElementById('mediaList').innerHTML = '';
      document.getElementById('projectList').innerHTML = '';
      document.getElementById('mediaTitle').style.display = 'none';
      document.getElementById('projectTitle').style.display = 'none';
      
      try {
        // Load media
        const mediaResponse = await fetch(`${API_URL}/media/${ownerType}/${ownerId}`);
        const mediaData = await mediaResponse.json();
        
        document.getElementById('mediaLoader').classList.remove('show');
        
        if (mediaData.length > 0) {
          document.getElementById('mediaTitle').style.display = 'block';
          let html = '';
          mediaData.forEach(item => {
            const isImage = item.file_type && item.file_type.startsWith('image/');
            const isLocal = item.file_url && item.file_url.startsWith('/uploads/');
            
            html += `
              <div class="media-item">
                ${isImage ? `<img src="${item.file_url}" alt="${item.file_name}" style="max-width: 100%; border-radius: 6px; margin-bottom: 10px;">` : ''}
                <h4>${item.file_name}</h4>
                <p><strong>Type:</strong> ${item.file_type}</p>
                <p><strong>${isLocal ? 'File' : 'URL'}:</strong> <a href="${item.file_url}" target="_blank">${isLocal ? 'View File' : item.file_url}</a></p>
                <p><strong>Uploaded:</strong> ${new Date(item.uploaded_on).toLocaleDateString()}</p>
                ${item.tags && item.tags.length > 0 ? `
                  <div class="tags">
                    ${item.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                  </div>
                ` : ''}
              </div>
            `;
          });
          document.getElementById('mediaList').innerHTML = html;
        } else {
          document.getElementById('mediaList').innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No media found</p>';
        }
        
        // Load projects (only for employees)
        if (ownerType === 'employee') {
          const projectResponse = await fetch(`${API_URL}/projects/${ownerId}`);
          const projectData = await projectResponse.json();
          
          if (projectData.length > 0) {
            document.getElementById('projectTitle').style.display = 'block';
            let html = '<div style="max-height: 400px; overflow-y: auto;">';
            projectData.forEach((project, index) => {
              const lat = parseFloat(project.latitude);
              const lon = parseFloat(project.longitude);
              html += `
                <div class="project-item">
                  <div>
                    <strong>${index + 1}. ${project.name}</strong><br>
                    <small style="color: #666;">Project ID: ${project.proj_id} | ${project.description || 'No description'}</small><br>
                    <small style="color: #999;">Location: ${lat.toFixed(4)}, ${lon.toFixed(4)}</small>
                  </div>
                  <button onclick="showOnMap(${lat}, ${lon}, '${project.name}')" style="width: auto; padding: 8px 16px; font-size: 12px;">üó∫Ô∏è View</button>
                </div>
              `;
            });
            html += '</div>';
            document.getElementById('projectList').innerHTML = html;
          }
        }
        
      } catch (err) {
        document.getElementById('mediaLoader').classList.remove('show');
        document.getElementById('mediaList').innerHTML = `<p style="color: red;">Error: ${err.message}</p>`;
      }
    }
    
    // Show location on map
    function showOnMap(lat, lon, name) {
      map.setView([lat, lon], 14);
      const tempMarker = L.marker([lat, lon], { icon: projectIcon })
        .addTo(map)
        .bindPopup(`<b>üìç ${name}</b>`)
        .openPopup();
      setTimeout(() => map.removeLayer(tempMarker), 5000);
    }
    
    // Load media (keep for backward compatibility)
    async function loadMedia() {
      loadEmployeeData();
    }
    
    // Add project location
    async function addProjectLocation(event) {
      event.preventDefault();
      
      const cityName = document.getElementById('cityName').value.trim();
      const lat = document.getElementById('latitude').value;
      const lon = document.getElementById('longitude').value;
      
      if (!lat || !lon) {
        showMessage('locationMessage', 'Please enter a city name and click Find, or click on the map to select coordinates', 'error');
        return;
      }
      
      const data = {
        proj_id: parseInt(document.getElementById('projId').value),
        name: document.getElementById('projName').value,
        description: document.getElementById('projDescription').value,
        lat: parseFloat(lat),
        lon: parseFloat(lon),
        city: cityName,
        employee_id: document.getElementById('employeeId').value,
        created_by: document.getElementById('createdBy').value
      };
      
      try {
        const response = await fetch(`${API_URL}/project-location`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
          showMessage('locationMessage', '‚úì Project location added! ID: ' + result.location_id, 'success');
          document.getElementById('locationForm').reset();
          document.getElementById('coordsDisplay').style.display = 'none';
          document.getElementById('latitude').readOnly = true;
          document.getElementById('longitude').readOnly = true;
          document.getElementById('latitude').style.background = '#f5f5f5';
          document.getElementById('longitude').style.background = '#f5f5f5';
          
          // Add marker to map
          const marker = L.marker([result.latitude, result.longitude], { icon: projectIcon })
            .addTo(map)
            .bindPopup(`<b>üìç ${data.name}</b><br>${data.description}`)
            .openPopup();
          markers.push(marker);
          
          map.setView([result.latitude, result.longitude], 12);
          
          // Refresh all projects list
          loadAllProjects();
        } else {
          showMessage('locationMessage', 'Error: ' + result.error, 'error');
        }
      } catch (err) {
        showMessage('locationMessage', 'Error: ' + err.message, 'error');
      }
    }
    
    // Find nearest projects (removed)
    
    // Load all projects
    async function loadAllProjects() {
      document.getElementById('projectsLoader').classList.add('show');
      document.getElementById('projectsList').innerHTML = '';
      
      try {
        const response = await fetch(`${API_URL}/all-projects`);
        const data = await response.json();
        
        document.getElementById('projectsLoader').classList.remove('show');
        
        if (data.length === 0) {
          document.getElementById('projectsList').innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No projects found</p>';
          return;
        }
        
        let html = '<div style="max-height: 500px; overflow-y: auto;">';
        data.forEach((project, index) => {
          const lat = parseFloat(project.latitude);
          const lon = parseFloat(project.longitude);
          html += `
            <div class="project-item">
              <div>
                <strong>${index + 1}. ${project.name}</strong><br>
                <small style="color: #666;">Project ID: ${project.proj_id} | Employee: ${project.employee_id || 'N/A'}</small><br>
                <small style="color: #999;">${project.description || 'No description'}</small><br>
                <small style="color: #999;">üìç ${lat.toFixed(4)}, ${lon.toFixed(4)}</small>
              </div>
              <button onclick="showOnMap(${lat}, ${lon}, '${project.name}')" style="width: auto; padding: 8px 16px; font-size: 12px;">üó∫Ô∏è View</button>
            </div>
          `;
        });
        html += '</div>';
        
        document.getElementById('projectsList').innerHTML = html;
      } catch (err) {
        document.getElementById('projectsLoader').classList.remove('show');
        document.getElementById('projectsList').innerHTML = `<p style="color: red;">Error: ${err.message}</p>`;
      }
    }
    
    // Show message helper
    function showMessage(elementId, message, type) {
      const el = document.getElementById(elementId);
      el.textContent = message;
      el.className = `message ${type} show`;
      setTimeout(() => el.classList.remove('show'), 5000);
    }
    
    // Initialize
    loadLocations();
  </script>
</body>
</html>
